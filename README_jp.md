## 日本語ドキュメント：

pickCardFgoはスマホゲームのFate/GrandOrderのガチャ項目を抽出して、Javascriptを使用して構築したWebアプリです。これより機能と原理を簡単に説明します。

#### 原理:

この項目はclient-serverモデルに従い作成されました。フロントエンドは[React](https://reactjs.org)、バックエンドは[Node.js](https://nodejs.org)+[Express](https://expressjs.com)、データベースは[Mongodb](https://mongodb.com)。フロントエンドにおいて、Reactの部分は.jsxのフォーマットで作成し、[Webpack](https://webpack.js.org )と[babel](https://babeljs.io )の[babel-loader](https://github.com/babel/babel-loader )によりトランスパイルを実装しました。Webpackは`.jsx`を古いバージョンのJSに変更する機能を果たしています。また、[axios](https://github.com/axios/axios )を使用し、Ajaxのリクエストを出すため、ノーリフレッシュのシングルページで全てのデータのやりとりを実現できました。バックエンドのNodejsはExpressフレームワークを使用し、"/"のstaticPathをserveしました。また、それに基づき、静的にindex.htmlをserveすることによって、CORSの問題を回避しました。データベースのMongoDBは事先にfgoカードの情報がインポートされ、fgoというDBのcardsというcollection中保存されました。このプロジェクトの実行例は"pickcard.net-labo.icu"というドメイン名を使用し、[AlibabaCloud](https://www.alibabacloud.com)を通じてDNS名前解決を対応しています。それに加えて[AWS EC2](https://aws.amazon.com/ec2 )を使用してインフラ構築を行い、npm環境のpm2でサービスの安定性を確保しています。

**準備として：**

1. ドメイン名：http://pickcard.net-labo.icu　を入手し、AliCloudを利用してそれをAWS EC2のサーバに対応します。

2. AWS EC2の環境構築を行い、npmとそのdependenceをインストールします。次にMongoDBをインストールしてデータを復元します。

3. サーバを起動し、index.htmlをドメイン名のルート"/"にserveします。

4. ユーザはWebブラウザでドメイン名にアクセスします。

**作動方式：**

1. ユーザはクライアント側でインタラクティブな行動をとる時、onclickイベントが発動されます。このイベントはaxios関数に対応しています。この関数はサーバ側にAjax方式のGET(Request）を送ります。

2. サーバ側はGETをもらい、内容を読み込んで、その内容に基づきデータベースのデータをサーチします。結果が出たら、それをResponseとしてクライアント側に送ります。

3. クライアント側はResponseをもらい、内容を読み込んで、そしてUIを通じてユーザに示します。

#### 機能：

- `Pick 1 card` ボタン：当期のカードプールからカード１枚をガチャします。

- `Pick 10 cards` ボタン：当期のカードプールからカード10枚をガチャします。同時に保証ルールが適用されます。

- `Calculate` ボタン：独立な機能である。当期カードプールからピックアップされたカードの排出率とそのため消耗した資源（ゲーム内通貨、現実通貨、ガチャ回数など）を算出します。

- ##### コンテンツの说明：

1. 自由モード（聖晶石のアイコンでバツが表示される）において，ガチャは聖晶石を使用しません。

2. 標準モード（聖晶石のアイコンでバツが表示されない）において，ガチャはゲームのように聖晶石を使用します。具体的に：1回ガチャにつき、聖晶石3個使用します，10連ガチャにつき、聖晶石3個使用します。

3. 標準モードにおいて，聖晶石の数がガチャの必須個数より低い場合，項目は「聖晶石を購入しますか」というメッセージを提示します。購入を許可する場合は167がチャージされ，ガチャを続行することができます。

4. 標準モードにおいて，聖晶石の数がガチャの必須個数より低いかつ聖晶石の購入を確認できない場合，ガチャを続行することができません。


#### リニューアルポイント：


1.　JSフレームワークについて

古いバージョンのJSフレームワークはVueを使ったが，今回はReactに変えた。最近ちょうどReactとWebpackの勉強をやったので、練習として作品をもう一度作ると思ってやり直した。現在のフロントエンド開発はMicroserviceの影響を受けて，コンポーネント指向のアジャイル開発が大範囲で応用されている。そしてVueとReactはコンポーネントを完全にサポートできるフレームワークとして、現在の主流になってるのも当然。個人としては，やはりReactと相性が良いと思う。理由は全てを1つのjsxファイルにまとめられる。やはりこのやり方は便利ね、テンプレートのVueより開発効率が高くなると思う。jsxはHTMLとJS、時にCSSを混ぜて使用するフォーマットだが，なれたあとは逆に使い安いと感じるので、今後の開発もReactを使ってみようと思ってる。Reactという技術スタックにはいろいろ深いものがある，例えばTypeScriptやReduxなど。今後TSとReduxの勉強が終わったら、もう１度このプロジェクトを書き直すこともある(^_^)。

2. トランスパイルについて

古いバージョンのJS直接Vueの互換性モードでできたが、今回はjsxを使ったため、Webpackを導入して、babel-loaderを使って，jsxをバニラJSにトランスパイルした。目的は２つある。１つ目は、現在ちょうどWebpackの知識を勉強しているので、Webpack.config.jsの配置の練習として、使ってみた。２つ目は互換性を保つことだ。今のWeb開発、特にフロントエンド開発は最新の技術を使っている。でもやはりWeb関連なものだから、Webブラウザに依存している。そして今多くのブランドの違うバージョンのWebブラウザがあるので、たとえ同じものを見ても、表現がそれぞれ違うことも時々起こる。それを解決するために、やはり古いバージョンのJSに戻って、古いWebブラウザでも閲覧可能の状態に調整した。こうして、ユーザの閲覧体験も高まると思う。

3. HTMLの要素について

今回のバージョンは古いバージョンみたいにHTMLファイルで静的に要素を宣言するじゃなくて、ReactのバーチャルDOMを利用して、動的な宣言方式を使った。これはJS開発のTreeShading法則を守ためだ。ブラウザに対して、RenderTreeに実在する要素、たとえ空の要素（EmptyElement）であっても、Webブラウザはそれを条件なくレンダリングする。それに対して、もし動的な宣言方法を使用し、必要である要素だけを宣言することによって、無駄なレンダリングはなく、Webブラウザのレンダリング効率が上がることも実現できる。それと同時にコンピュータ性能も上がると推測できる。

4. データベースの選び方について

古いバージョンと同じく，今回の新しいバージョンもMongoDBというnoSQL(not only SQL)でカードのデータを保存します。なぜMySQLなどRDBMSを使わないというと、やはりSQLはデータのフォーマット対して厳格にすぎると思う。全てのデータの書式と種類、すなわちスキーマが完全に一致しないと、表に入れることができない。逆にMongoDBなどDODBに対して、データのスキーマが要求されなく、自由なデータを扱うことができる。特に今のゲーム情報データに対して、それの多くはスキーマが一致しないので、無理矢理にSQLを使用することが、かなり不自由になる。また、noSQLは表という二次元のフォーマット以外、JSONを用いて、立体なデータ構造が実現できると思うので、静的なデータベースにふさわしいと思っている。その真逆に、RDBMSは厳格な対応関係が必要かつ頻繁に変わるデータに対し、ふさわしいデータベースだと思う。



#### 利用方法：

##### 1. プロジェクトダウンロードと和環境構築
このプロジェクトはNode.jsの環境で作動します。もしNode.jsの環境がない場合，[Node.jsオフィシャルサイト](https://nodejs.org)にアクセスして、ふさわしいバージョンのNode.jsをインストールしてください。
ついでに、[Git](https://git-scm.com/downloads )をインストールしてくだい。

Node.jsの環境が揃えたかつGitをインストールしましたら，shellに

`git clone https://github.com/killbe5419/pickCardFgo_New.git` 

コマンドを入力してプロジェクトをクローンします。次に、

`cd pickCardFgo_New`

を入力してプロジェクトのディレクトリに入ります。最後に

`npm install`

を入力して必要なパッケージをインストールします。

##### 2. データベースの導入
このプロジェクトをロンカルで作動させるために、MongoDBが必要です。もしMongoDBの環境がない場合，[MongoDBオフィシャルサイト](https://docs.mongodb.com/manual/installation/ )にアクセスして、ふさわしいバージョンのMongoDBをインストールして、そして指示通り`mongod`を起動してください。
また、.zipファイルを解凍するためのツールを用意してください。

MongoDBをインストールして、`mongod`を起動しましたら，shellで

`cd pickCardFgo_New`

を入力してプロジェクトのディレクトリに入り、解凍ツールでfgo.zipを解凍します。そして

`mongorestore -d fgo -h localhost:27017 fgo`

を入力して、DBのBackupをDBに復元します。

##### 3. サーバ起動
前２つの操作が全部完成したら，shellに

`cd pickCardFgo_New`

を入力してプロジェクトのディレクトリに入り、そして

`npm run server`

を入力してサーバを起動します。その後Webブラウザで

[http://localhost:2333](http://localhost:2333) 

にアクセスすれば、プロジェクトを動けます。

面倒だと考える方もいると思うので，このアプリを同時に[My site](http://pickcard.net-labo.icu:2333)に実装しました。もし興味があるなら、サイトにアクセスして、実行例を見て、いろいろやってみてください！性能の悪いバーチャルサーバを使用していますので、実際スムーズに動けない時もあります。それに対してすみませんと思いますが、根性を持って待つことをお願いします。気に入ってくれると嬉しいです！
